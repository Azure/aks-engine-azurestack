# Rotating Kubernetes Certificates

## Prerequisites

This guide assumes that you already have deployed a cluster using `aks-engine-azurestack` and the cluster is in a healthy state.

## Certificate Rotation

This document provides guidance on how to rotate certificates on an existing AKS Engine cluster and recommendations for adopting `aks-engine-azurestack rotate-certs` as a tool.

### Know before you go

In order to ensure that your `aks-engine-azurestack rotate-certs` operation runs smoothly, there are a few things you should be aware of before getting started.

1. You will need access to the API Model (`apimodel.json`) that was generated by `aks-engine-azurestack deploy` or `aks-engine-azurestack generate` (by default this file is placed into a relative directory that looks like `_output/<clustername>/`).

1. An `aks-engine-azurestack rotate-certs` operation causes API Server downtime.

1. `aks-engine-azurestack rotate-certs` expects an API model that conforms to the current state of the cluster. `aks-engine-azurestack rotate-certs` executes remote commands on the cluster nodes and uses the API Model information to establish a secure SSH connection. `aks-engine-azurestack rotate-certs` also relies on some resources (such as VMs) to be named in accordance with the original `aks-engine-azurestack` deployment.

1. `aks-engine-azurestack rotate-certs` relies upon a working connection to the cluster control plane during certificate rotation, both (1) to validate each step of the process, and (2) to restart/recreate cluster resources like `kube-system` pods and service account tokens. If you are rotating the certificates of a **private cluster**, you must run `aks-engine-azurestack rotate-certs` from a host VM that has network access to the control plane, for example a jumpbox VM that resides in the same VNET as the master VMs. For more information on private clusters [refer to this documentation](features.md#feat-private-cluster).

1. If using `aks-engine-azurestack rotate-certs` in production, it is recommended to stage a certificate rotation test on an cluster that was built to the same specifications (built with the same cluster configuration + the same version of the `aks-engine-azurestack` command line tool + the same set of enabled addons) as your production cluster before performing the certificate rotation. The reason for this is that AKS Engine supports many different cluster configurations and the extent of E2E testing that the AKS Engine team runs cannot practically cover every possible configuration. Therefore, it is recommended that you ensure in a staging environment that your specific cluster configuration works with `aks-engine-azurestack rotate-certs` before attempting this potentially destructive operation on your production cluster.

1. `aks-engine-azurestack rotate-certs` does **not** guarantees backwards compatibility. If you deployed with `aks-engine-azurestack` version `0.60.x`, you should prefer executing the certificate rotation process with version `0.60.x`.

### Parameters

|Parameter|Required|Description|
|-----------------|---|---|
|--api-model|yes|Relative path to the API model (cluster definition) that declares the expected cluster configuration.|
|--ssh-host|yes|FQDN, or IP address, of an SSH listener that can reach all nodes in the cluster.|
|--linux-ssh-private-key|yes|Path to a valid private SSH key to access the cluster's Linux nodes.|
|--location|yes|Azure location where the cluster is deployed.|
|--subscription-id|yes|Azure subscription where the cluster infra is deployed.|
|--resource-group|yes|Azure resource group where the cluster infra is deployed.|
|--client-id|depends|The Service Principal Client ID. Required if the auth-method is set to client_secret or client_certificate.|
|--client-secret|depends| The Service Principal Client secret. Required if the auth-method is set to client_secret.|
|--azure-env|depends| The target cloud name. Optional if target cloud is AzureCloud.|
|--certificate-profile|no|Relative path to a JSON file containing the new set of certificates.|
|--force|no|Force execution even if API Server is not responsive.|

### Simple steps to rotate certificates

Once you have read all the [requirements](#pre-requirements), run `aks-engine-azurestack rotate-certs` with the appropriate arguments:

```bash
./bin/aks-engine-azurestack rotate-certs \
  --location <resource-group-location> \
  --api-model <generated-apimodel.json> \
  --linux-ssh-private-key <private-SSH-key> \
  --ssh-host <apiserver-URI> \
  --resource-group <resource-group-name> \
  --client-id <service-principal-id> \
  --client-secret <service-principal-secret> \
  --subscription-id <subscription-id> \
  --azure-env <cloud-name>
```

For example,

```bash
./bin/aks-engine-azurestack rotate-certs \
  --location "westus2" \
  --api-model "_output/my-cluster/apimodel.json" \
  --linux-ssh-private-key "~/.ssh/id_rsa" \
  --ssh-host "my-cluster.westus2.cloudapp.azure.com"\
  --resource-group "my-cluster" \
  --client-id "12345678-XXXX-YYYY-ZZZZ-1234567890ab" \
  --client-secret "12345678-XXXX-YYYY-ZZZZ-1234567890ab" \
  --subscription-id "12345678-XXXX-YYYY-ZZZZ-1234567890ab" \
  --azure-env "AzureStackCloud" # optional if targeting AzureCloud
```

> Fetching a new set of certificates from Key Vault is not supported at this point.

## Under The Hood

A Kubernetes cluster relies on multiple PKIs to secure the communication between its components (apiserver, kubelet, etcd, etc). An AKS Engine cluster uses 2 certificate authorities (CA), one for the front-proxy PKI and another one for the remaining PKIs. On control plane nodes, `aks-engine-azurestack rotate-certs` rotates the non-front-proxy PKIs first, reboots the virtual machines, and finally rotates the front-proxy PKI. On agent nodes, `kubelet` and `kube-proxy` are restarted once the node certificates are replaced.

If the certificate rotation process halts before completion due to a failure or transient issue (e.x.: network connectivity), it is safe to rerun `aks-engine-azurestack rotate-certs` using the `--force` flag.

At a high level, the `aks-engine-azurestack rotate-certs` command performs the following tasks:

- backup current set of certificates in directory `_rotate_certs_backup/` (relative to the `--api-model` path)
- generate/load new set of certificate and persist them in local directory `_rotate_certs_output/` (relative to the `--api-model` path)
- distribute certificates to the cluster nodes over SSH
- rotate control plane certificates (except front-proxy PKI)
- reboot control plane nodes
- wait for the cluster to reach a healthy state
- rotate front-proxy certificates
- rotate agent certificates
- update input `apimodel.json` with new certificates information

### SSH StrictHostKeyChecking

The SSH option `StrictHostKeyChecking` is a security feature that affects how SSH verifies the identity of a remote computer when connecting to it.
SSH automatically checks and persists in local file `~/.ssh/known_hosts` the identity of all the hosts that have ever been used in host key checks.

When this option is enabled, the SSH client will automatically reject any key from the server that does not match the one stored in its `known_hosts` file.
This helps protect against man-in-the-middle attacks, where an attacker may attempt to impersonate the server by providing a different hostkey.

Starting with AKS Engine v0.77.0, `StrictHostKeyChecking` will be enforced during the execution of the `aks-engine-azurestack rotate-certs` command.
Hence, new entries will be appended to the local `known_hosts` file if no SSH sessions to the remove host were established in the past.

### Generating certificates

`aks-engine-azurestack rotate-certs` is able to generate the new set of certificates that will be deployed to the cluster based on the information found in the API model.

Alternatively, AKS Engine can load a new set of certificates from a JSON file specified in `--certificate-profile`.

```json
{
  "certificateProfile": {
    "caCertificate": "",
    "caPrivateKey": "",
    "apiServerCertificate": "",
    "apiServerPrivateKey": "",
    "clientCertificate": "",
    "clientPrivateKey": "",
    "kubeConfigCertificate": "",
    "kubeConfigPrivateKey": "",
    "etcdServerCertificate": "",
    "etcdServerPrivateKey": "",
    "etcdClientCertificate": "",
    "etcdClientPrivateKey": "",
    "etcdPeerCertificates": ["","",""],
    "etcdPeerPrivateKeys": ["","",""]
  }
}
```

### Certificates distribution

The new certificates are securely copied to each cluster node before the certificates rotation process starts. On Linux nodes, they are located in directory `/etc/kubernetes/rotate-certs/certs`. On Windows nodes, the directory is `$env:temp`.

## Best Practices

### Use a reliable network connection

`aks-engine-azurestack rotate-certs` requires the execution of multiple remote commands which are subject to potential failures, mostly if the connection to the cluster nodes is not reliable.

Executing `aks-engine-azurestack rotate-certs` from a VM running on the target cloud can drastically reduce the occurence of transient issues.

## Known Limitations

### Cluster-autoscaler

`aks-engine-azurestack rotate-certs` will not update the ARM template that `cluster-autoscaler` uses to create new cluster nodes. Because the cluster certificates are embedded in the ARM template, the addon won't be able to produce functioning agent nodes after a certificate rotation operation. An `aks-engine-azurestack upgrade` operation will take care of updating the "new node" template.

## Troubleshooting

`aks-engine-azurestack rotate-certs` logs the output of every step in file `/var/log/azure/rotate-certs.log` (Linux) and `c:\k\rotate-certs.log` (Windows).

## Frequently Asked Questions

### How to rotate the front-proxy certificates

Older AKS Engine releases (before v0.65.0) create a front-proxy PKI that expires after 2 years (730 days).

Errors executing `kubectl top` are an indication that the front-proxy certificates are expired.
To confirm, check the `metrics-server` logs and/or run the following command:

```bash
sudo openssl x509 -noout -in /etc/kubernetes/certs/proxy.crt -enddate
```

If the front-proxy certificates expired and the cluster was updated to AKS Engine v0.65.0 or greater,
then execute `aks-engine rotate-certs` to renew them. 

If the cluster was **not** updated to AKS Engine v0.65.0 or greater,
then a set of manual steps are required:

#### 1. On master 0 as `root`

- Delete certificate data from `etcd`
  ```bash
  ETCDCTL_ENDPOINTS="${ETCDCTL_ENDPOINTS:=https://127.0.0.1:2379}"
  ETCDCTL_CA_FILE="${ETCDCTL_CA_FILE:=/etc/kubernetes/certs/ca.crt}"
  ETCD_CA_PARAM="--cacert=${ETCDCTL_CA_FILE}"
  ETCDCTL_KEY_FILE="${ETCDCTL_KEY_FILE:=/etc/kubernetes/certs/etcdclient.key}"
  ETCDCTL_CERT_FILE="${ETCDCTL_CERT_FILE:=/etc/kubernetes/certs/etcdclient.crt}"
  ETCDCTL_PARAMS="--command-timeout=30s --cert=${ETCDCTL_CERT_FILE} --key=${ETCDCTL_KEY_FILE} ${ETCD_CA_PARAM} --endpoints=${ETCDCTL_ENDPOINTS}"
  # delete etcd entries
  ETCDCTL_API=3 etcdctl ${ETCDCTL_PARAMS} del "/proxycerts/requestheader-client-ca-file"
  ETCDCTL_API=3 etcdctl ${ETCDCTL_PARAMS} del "/proxycerts/proxy-client-key-file"
  ETCDCTL_API=3 etcdctl ${ETCDCTL_PARAMS} del "/proxycerts/proxy-client-cert-file"
  ```
- Download latest front-proxy generation script
  ```bash
  curl -L https://raw.githubusercontent.com/Azure/aks-engine-azurestack/master/parts/k8s/cloud-init/artifacts/generateproxycerts.sh -o generate-proxy-certs.sh
  chmod +x generate-proxy-certs.sh
  ```
- Execute the script
  ```bash
  source /etc/environment
  export OVERRIDE_PROXY_CERTS=true
  ./generate-proxy-certs.sh
  ```
- Verify new expiration date
  ```bash
  sudo openssl x509 -noout -in /etc/kubernetes/certs/proxy.crt -enddate
  ```
- Reboot server

#### 2. On the rest of master nodes as `root`

- Download latest front-proxy generation script
  ```bash
  curl -L https://raw.githubusercontent.com/Azure/aks-engine-azurestack/master/parts/k8s/cloud-init/artifacts/generateproxycerts.sh -o generate-proxy-certs.sh
  chmod +x generate-proxy-certs.sh
  ```
- Execute the script
  ```bash
  source /etc/environment
  ./generate-proxy-certs.sh
  ```
- Verify new expiration date
  ```bash
  sudo openssl x509 -noout -in /etc/kubernetes/certs/proxy.crt -enddate
  ```
- Reboot server

#### 3. Regenerate metrics-server secret

- Delete the existing secret and redeploy metrics-server 
  ```bash
  SECRET_NAME=$(kubectl get sa metrics-server -n kube-system -o json | jq -r '.secrets | map(.name)[0]')

  kubectl delete secret $SECRET_NAME -n kube-system
  kubectl rollout restart deploy metrics-server -n kube-system
  ```
