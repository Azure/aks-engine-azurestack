{
    "type": "Microsoft.VirtualMachineImages/imageTemplates",
    "apiVersion": "2022-02-14",
    "location": "eastus",
    "dependsOn": [],
    "tags": {
        "userIdentity": "enabled"
    },
    "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
            "/subscriptions/a2b58cb8-c2cf-4afe-af64-63ed4dab8628/resourcegroups/AKSeVHDs/providers/Microsoft.ManagedIdentity/userAssignedIdentities/akse-e2e-uai": {}    
        }
    },
    "properties": {
        "buildTimeoutInMinutes" : 180,
        "vmProfile": 
            {
                "vmSize": "Standard_D2s_v3",
                "osDiskSizeGB": 127,
                "vnetConfig": {
                    "subnetId": "/subscriptions/a2b58cb8-c2cf-4afe-af64-63ed4dab8628/resourceGroups/AKSeImageBuilderVnetRG/providers/Microsoft.Network/virtualNetworks/AKSeImageBuilderVnet/subnets/AKSeImageBuilderSubnet"
                }
            },
        "source": {
            "type": "PlatformImage",
            "publisher": "MicrosoftWindowsServer",
            "offer": "WindowsServer",
            "sku": "2019-Datacenter-Core-smalldisk",
            "version": "17763.5329.231230"
        },
        "customize": [
            {
                "type": "PowerShell",
                "name": "configure-windows-vhd-phase1",
                "runElevated": true,
                "scriptUri": "https://raw.githubusercontent.com/Azure/aks-engine-azurestack/users/hafa/aib-test/vhd/packer/configure-windows-vhd-phase1.ps1"
            },
            {
                "type": "WindowsRestart",
                "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM  > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                "restartTimeout": "10m"
            },
            {
                "type": "WindowsRestart",
                "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM  > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                "restartTimeout": "10m"
            },
            {
                "type": "PowerShell",
                "name": "configure-windows-vhd-phase2",
                "runElevated": true,
                "scriptUri": "https://raw.githubusercontent.com/Azure/aks-engine-azurestack/users/hafa/aib-test/vhd/packer/configure-windows-vhd-phase2.ps1"
            },
            {
                "type": "WindowsRestart",
                "restartCheckCommand": "echo Azure-Image-Builder-Restarted-the-VM  > c:\\buildArtifacts\\azureImageBuilderRestart.txt",
                "restartTimeout": "10m"
            },
            {
                "type": "File",
                "name": "download log collection script",
                "sourceUri": "https://raw.githubusercontent.com/Azure/aks-engine-azurestack/master/scripts/collect-windows-logs.ps1",
                "destination":"c:\\akse-cache\\collect-windows-logs.ps1"
            },
            {
                "type": "File",
                "name": "download notice",
                "sourceUri": "https://raw.githubusercontent.com/Azure/aks-engine-azurestack/master/vhd/notice/notice_windows.txt",
                "destination":"c:\\NOTICE.txt"
            }
        ],
        "distribute": 
        [
            {   
                "type": "SharedImage",
                "galleryImageId": "/subscriptions/a2b58cb8-c2cf-4afe-af64-63ed4dab8628/resourceGroups/AKSeVHDs/providers/Microsoft.Compute/galleries/AKSeImagesTestGallery/images/windows2019containerd",
                "runOutputName": "AKSeWindowsTest",
                "artifactTags": {
                    "baseosimg": "windows2019"
                },
                "replicationRegions": [
                  "eastus"
                ]
            },
            {
                "type": "VHD",
                "runOutputName": "AKSeWindowsTestVHD",
                "artifactTags": {
                    "baseosimg": "windows2019"
                },
                "uri": "https://akseashvhds.blob.core.windows.net/test/AKSeWindowsTest.vhd"
            }
        ]
    }
}

